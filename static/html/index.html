<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>博客页面</title>
    <style>
        html, body { min-height: 100vh; }
        body {
            margin: 0;
            font-family: 'Segoe UI', 'Arial', sans-serif;
            /* 直接使用背景图，确保可见 */
            background: #0c0f14 url('/static/img/%E8%83%8C%E6%99%AF.jpg') center center / cover no-repeat fixed;
        }
        /* 全屏画布用于花瓣特效 */
        #bg-canvas {
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            width: 100%; height: 100%;
            z-index: 0;
            pointer-events: none;
        }
        .navbar {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 20px;
            background: #222;
            color: #fff;
            padding: 0 32px;
            height: 60px;
        }
        .navbar-title {
            font-size: 1.5rem;
            font-weight: bold;
            letter-spacing: 2px;
        }
        .navbar-actions {
            display: flex;
            gap: 16px;
            margin-left: auto;
        }
        .navbar-actions a {
            color: #fff;
            text-decoration: none;
            padding: 8px 18px;
            border-radius: 4px;
            background: #007bff;
            transition: background 0.2s;
        }
        .navbar-actions a:hover {
            background: #0056b3;
        }
        .user-welcome {
            color: #fff;
            padding: 8px 18px;
            background: #28a745;
            border-radius: 4px;
            margin-right: 10px;
        }
        .navbar-actions a.user-welcome {
            background: #28a745 !important;
            color: #fff !important;
        }
        .logout-btn {
            color: #fff !important;
            background: #dc3545 !important;
        }
        .logout-btn:hover {
            background: #c82333 !important;
        }
        .main-content {
            margin: 40px auto;
            max-width: 1000px;
            /* 毛玻璃容器 */
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.18);
            border-radius: 16px;
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
            backdrop-filter: blur(16px) saturate(120%);
            -webkit-backdrop-filter: blur(16px) saturate(120%);
            padding: 32px;
            min-height: 300px;
            position: relative;
            z-index: 1;
            color: #111;
        }
        .blog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid rgba(255,255,255,0.12);
            padding-bottom: 20px;
        }
        .blog-header h2 {
            margin: 0;
            color: #111;
        }
        .btn-new-blog {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        .btn-new-blog:hover {
            background: #218838;
        }
        .blog-list {
            min-height: 200px;
        }
        .blog-item {
            background: rgba(255,255,255,0.06);
            border: 1px solid rgba(255,255,255,0.16);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: box-shadow 0.2s, background 0.2s, transform 0.15s ease;
            cursor: pointer;
        }
        .blog-item:hover {
            background: rgba(255,255,255,0.10);
            box-shadow: 0 10px 28px rgba(0,0,0,0.25);
            transform: translateY(-1px);
        }
        .blog-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            object-fit: cover;
            background: #f0f0f0;
            flex: 0 0 28px;
        }
        .avatar-fallback {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: #555;
            border: 1px solid #e1e1e1;
        }
        .blog-title {
            font-size: 1.4em;
            font-weight: bold;
            color: #111;
            margin-bottom: 10px;
        }
        .blog-summary {
            color: #111;
            line-height: 1.6;
            margin-bottom: 15px;
        }
        .blog-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: #111;
        }
        .blog-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            font-size: 12px;
            color: #111;
        }
        .metrics {
            display: flex;
            gap: 14px;
            align-items: center;
            color: #111;
        }
        .metric {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .blog-author {
            font-weight: bold;
            color: #111;
        }
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 30px;
            gap: 10px;
        }
        .pagination button {
            padding: 8px 12px;
            border: 1px solid #ddd;
            background: white;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:hover {
            background: #f8f9fa;
        }
        .pagination button.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }
        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        /* 模态框样式 */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }
        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .modal-header h3 {
            margin: 0;
        }
        .close {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        .close:hover {
            color: #333;
        }
        .modal-body {
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .form-group textarea {
            resize: vertical;
            font-family: inherit;
        }
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 30px;
        }
        .form-actions button {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .form-actions button[type="submit"] {
            background: #007bff;
            color: white;
        }
        .form-actions button[type="button"] {
            background: #6c757d;
            color: white;
        }
        /* 留言弹窗额外样式可复用通用modal */
        /* 代码块样式 */
        pre {
            background: #f6f8fa;
            padding: 12px;
            border-radius: 6px;
            overflow: auto;
        }
        pre code {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 13px;
        }
        /* 顶部下拉菜单（导航栏左侧，和登录注册同一行） */
        .header-menus { display:flex; gap:10px; margin-left: 12px; }
        .menu-dropdown { position: relative; }
        .menu-dropdown-btn { padding: 8px 14px; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 999px; cursor: pointer; }
        .menu-dropdown-btn:hover { background: #eef2f7; }
        .menu-dropdown-menu {
            position: absolute; top: calc(100% + 6px); right: 0; min-width: 170px; background: #fff; border: 1px solid #e9ecef; border-radius: 10px; box-shadow: 0 10px 28px rgba(0,0,0,0.12); padding: 10px; display: none; z-index: 10;
        }
        .menu-dropdown.open .menu-dropdown-menu { display: block; }
        .menu-dropdown-menu a {
            display:block; padding:10px 12px; border-radius:8px; color:#333; text-decoration:none;
        }
        .menu-dropdown-menu a:hover { background:#f1f5ff; }
        .menu-dropdown-menu a.disabled { color:#aaa; pointer-events:none; }
        /* 简单暗色切换 */
        body.dark { background: #0f1113; color: #e5e7eb; }
        body.dark .navbar { background: #0b0d10; }
        body.dark .main-content {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.18);
            color: #f5f7fb;
        }
        body.dark .blog-header { border-bottom-color: rgba(255,255,255,0.12); }
        body.dark .blog-header h2 { color: #f5f7fb; }
        body.dark .blog-item {
            background: rgba(255,255,255,0.08);
            border-color: rgba(255,255,255,0.16);
        }
        body.dark .blog-title { color: #ffffff; }
        body.dark .blog-summary { color: #e6ebf5; }
        body.dark .blog-meta { color: #d6deea; }
        body.dark .blog-footer { color: #d6deea; }
        body.dark .metrics { color: #d6deea; }
        body.dark .blog-author { color: #ffffff; }
    </style>
  <!-- 代码高亮与Markdown解析 -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.1.6/purify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
</head>
<body>
    <canvas id="bg-canvas"></canvas>
    <nav class="navbar">
        <div class="navbar-title">博客页面</div>
        <div class="header-menus">


            <div class="menu-dropdown">
                <button class="menu-dropdown-btn">功能</button>
                <div class="menu-dropdown-menu">
                    <a href="#" id="menu-refresh">刷新列表</a>
                    <a href="#" id="menu-top">回到顶部</a>
                    <a href="#" id="menu-toggle-theme">浅/深色切换</a>
                </div>
            </div>
            <div class="menu-dropdown">
                <button class="menu-dropdown-btn">分类</button>
                <div class="menu-dropdown-menu">
                    <a href="#" >博客</a>
                    <a href="/software">软件</a>
                    <a href="/f" >功能</a>
                </div>
            </div>
            <div class="menu-dropdown">
                <button class="menu-dropdown-btn">更多</button>
                <div class="menu-dropdown-menu">    
                    <a href="#" id="menu-contact">联系我</a>
                    <a href="#" id="menu-about">关于我</a>
                    <a href="#" id="menu-chat">留言</a>
                </div>
            </div>
        </div>
        <div class="navbar-actions" id="navbar-actions">
            <!-- 动态内容将通过JavaScript插入 -->
        </div>
    </nav>
    <div class="main-content">
        <!-- 博客操作区域 -->
        <div class="blog-header">
            <h2>博客文章</h2>
            <div style="display:flex; gap:8px; align-items:center; margin-left:auto;">
                <div id="blog-filter" style="display:flex; gap:6px;">
                    <button id="filter-published" type="button" style="padding:6px 10px;">已发布</button>
                    <button id="filter-drafts" type="button" style="padding:6px 10px;">草稿</button>
                </div>
                <button id="new-blog-btn" class="btn-new-blog" style="display: none;">新建博客</button>
            </div>
        </div>
        
        <!-- 博客列表 -->
        <div id="blog-list" class="blog-list">
            <div class="loading">加载中...</div>
        </div>
        
        <!-- 分页 -->
        <div id="pagination" class="pagination" style="display: none;"></div>
    </div>

    <!-- 页脚：网站访问计数 -->
    <div id="site-visit-footer" style="
        position: fixed; bottom: 10px; left: 50%; transform: translateX(-50%);
        background: rgba(0,0,0,0.55); color: #fff; padding: 6px 12px; border-radius: 16px;
        font-size: 14px; z-index: 1001;">
        网站已接待：<span id="site-visit-count">-</span> 人
    </div>

    <!-- 新建博客模态框 -->
    <div id="blog-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">新建博客</h3>
                <span class="close" onclick="closeBlogModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="blog-form">
                    <div class="form-group">
                        <label for="blog-title">标题</label>
                        <input type="text" id="blog-title" name="title" required>
                    </div>
                    <div class="form-group">
                        <label for="blog-summary">摘要（可选）</label>
                        <textarea id="blog-summary" name="summary" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="blog-content">内容</label>
                        <textarea id="blog-content" name="content" rows="10" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="blog-publish" name="status" value="1" checked>
                            立即发布
                        </label>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeBlogModal()">取消</button>
                        <button type="button" onclick="saveDraft()" style="background:#6c757d;color:#fff;">存为草稿</button>
                        <button type="submit">保存</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 博客详情模态框 -->
    <div id="blog-detail-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="detail-title">博客详情</h3>
                <span class="close" onclick="closeBlogDetailModal()">&times;</span>
            </div>
            <div class="modal-body">
                <h4 id="detail-blog-title"></h4>
                <div id="detail-meta" class="blog-meta" style="margin: 8px 0; color: #666; font-size: 12px;"></div>
                <p id="detail-summary" style="background:#f8f9fa; padding:10px; border-radius:6px;"></p>
                <div id="detail-content" style="margin-top:12px; white-space: pre-wrap;"></div>
                <div id="detail-actions" style="margin-top: 16px; text-align: right;"></div>
            </div>
        </div>
    </div>

    <!-- 通用信息模态框（关于我/联系我） -->
    <div id="info-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="info-title">信息</h3>
                <span class="close" onclick="closeInfoModal()">&times;</span>
            </div>
            <div class="modal-body" id="info-body"></div>
        </div>
    </div>

    <!-- 留言模态框 -->
    <div id="message-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>留言</h3>
                <span class="close" onclick="closeMessageModal()">&times;</span>
            </div>
            <div class="modal-body">
                <form id="message-form">
                    <div class="form-group">
                        <label for="message-text">请输入留言内容</label>
                        <textarea id="message-text" name="message" rows="5" required placeholder="说点什么吧..."></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="closeMessageModal()">取消</button>
                        <button type="submit">提交</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        // 检查用户登录状态并动态更新导航栏
        function updateNavbar() {
            const navbarActions = document.getElementById('navbar-actions');
            
            
            // 调用后端API检查登录状态
            fetch('/user/api/current', {
                method: 'GET',
                credentials: 'include', // 包含cookies以发送session
                cache: 'no-cache' // 禁用缓存
            })
            .then(response => {
                return response.json();
            })
            .then(data => {
                
                if (data.code === 200) {
                    currentUser = data.data;
                    // 用户已登录，显示欢迎信息和退出按钮
                    navbarActions.innerHTML = `
                        <a href="/user/settings" class="user-welcome">欢迎，${data.data.username}</a>
                        <a href="#" class="logout-btn" onclick="logout()">退出登录</a>
                    `;
                    // 显示新建博客按钮
                    document.getElementById('new-blog-btn').style.display = 'block';
                } else {
                    currentUser = null;
                    // 用户未登录，显示登录和注册按钮
                    navbarActions.innerHTML = `
                        <a href="/user/login">登录</a>
                        <a href="/user/register">注册</a>
                    `;
                    // 隐藏新建博客按钮
                    document.getElementById('new-blog-btn').style.display = 'none';
                }
            })
            .catch(error => {

                // 出错时显示登录和注册按钮
                navbarActions.innerHTML = `
                    <a href="/user/login">登录</a>
                    <a href="/user/register">注册</a>
                `;
            });
        }

        // 退出登录函数
        function logout() {
            if (confirm('确定要退出登录吗？')) {
                fetch('/user/api/logout', {
                    method: 'POST',
                    credentials: 'include' // 包含cookies以发送session
                })
                .then(response => response.json())
                .then(data => {
                    if (data.code === 200) {
                        alert('已退出登录');
                        updateNavbar();
                    } else {
                        alert('退出登录失败');
                    }
                })
                .catch(error => {

                    alert('退出登录过程中发生错误');
                });
            }
        }

        // 全局变量
        let currentUser = null;
        let currentPage = 1;
        let isSavingDraft = false;
        // 1=已发布, 0=草稿
        let currentStatusFilter = 1;

        // 页面加载时更新导航栏和加载博客
        document.addEventListener('DOMContentLoaded', function() {
            updateNavbar();
            setFilterActiveButton();
            loadBlogs();
            initHeaderMenus();
            initPetalEffects();
            // 页面加载后增加访问计数
            incrementVisitCounter();
            
            // 绑定新建博客按钮事件
            document.getElementById('new-blog-btn').addEventListener('click', openBlogModal);
            
            // 绑定博客表单提交事件
            document.getElementById('blog-form').addEventListener('submit', handleBlogSubmit);
            // 绑定筛选按钮
            const filterPublishedBtn = document.getElementById('filter-published');
            const filterDraftsBtn = document.getElementById('filter-drafts');
            if (filterPublishedBtn && filterDraftsBtn) {
                filterPublishedBtn.addEventListener('click', function(){
                    currentStatusFilter = 1;
                    currentPage = 1;
                    setFilterActiveButton();
                    loadBlogs(1);
                });
                filterDraftsBtn.addEventListener('click', function(){
                    currentStatusFilter = 0;
                    currentPage = 1;
                    setFilterActiveButton();
                    loadBlogs(1);
                });
            }
        });

        // 调用后端接口，自增并显示网站访问计数
        function incrementVisitCounter(){
            fetch('/api/metrics/visit', {
                method: 'GET',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                const count = (data && data.data && typeof data.data.count !== 'undefined')
                    ? data.data.count
                    : (typeof data?.count !== 'undefined' ? data.count : null);
                if (count !== null) {
                    const el = document.getElementById('site-visit-count');
                    if (el) el.textContent = count;
                }
            })
            .catch(() => {
                const el = document.getElementById('site-visit-count');
                if (el) el.textContent = '-';
            });
        }

        function setFilterActiveButton(){
            const pubBtn = document.getElementById('filter-published');
            const draftBtn = document.getElementById('filter-drafts');
            if (!pubBtn || !draftBtn) return;
            if (currentStatusFilter === 1) {
                pubBtn.style.background = '#007bff';
                pubBtn.style.color = '#fff';
                draftBtn.style.background = '';
                draftBtn.style.color = '';
            } else {
                draftBtn.style.background = '#007bff';
                draftBtn.style.color = '#fff';
                pubBtn.style.background = '';
                pubBtn.style.color = '';
            }
        }

        // 花瓣点击特效
        function initPetalEffects(){
            const canvas = document.getElementById('bg-canvas');
            const ctx = canvas.getContext('2d');
            const petals = [];

            function resize(){
                const dpr = Math.min(window.devicePixelRatio || 1, 2);
                canvas.width = Math.floor(window.innerWidth * dpr);
                canvas.height = Math.floor(window.innerHeight * dpr);
                canvas.style.width = window.innerWidth + 'px';
                canvas.style.height = window.innerHeight + 'px';
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
            }
            window.addEventListener('resize', resize);
            resize();

            // 生成花瓣对象
            function spawn(x, y){
                const count = 12 + Math.floor(Math.random()*8);
                for(let i=0;i<count;i++){
                    petals.push({
                        x, y,
                        vx: (Math.random()-0.5)*2.2,
                        vy: (Math.random()-1.2)*2.6,
                        life: 60 + Math.random()*40,
                        r: 4 + Math.random()*6,
                        rot: Math.random()*Math.PI*2,
                        vr: (Math.random()-0.5)*0.2,
                        hue: 300 + Math.random()*80
                    });
                }
            }

            // 点击与轻触触发
            document.addEventListener('pointerdown', e => {
                const rect = canvas.getBoundingClientRect();
                spawn(e.clientX - rect.left, e.clientY - rect.top);
            });

            function drawPetal(p){
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.rotate(p.rot);
                const grd = ctx.createRadialGradient(0,0,0,0,0,p.r*2);
                grd.addColorStop(0, `hsla(${p.hue}, 90%, 75%, .95)`);
                grd.addColorStop(1, `hsla(${p.hue}, 90%, 60%, 0)`);
                ctx.fillStyle = grd;
                ctx.beginPath();
                ctx.moveTo(0, -p.r);
                ctx.bezierCurveTo(p.r, -p.r, p.r, p.r, 0, p.r);
                ctx.bezierCurveTo(-p.r, p.r, -p.r, -p.r, 0, -p.r);
                ctx.fill();
                ctx.restore();
            }

            function tick(){
                ctx.clearRect(0,0,canvas.width, canvas.height);
                for(let i=petals.length-1;i>=0;i--){
                    const p = petals[i];
                    p.x += p.vx;
                    p.y += p.vy;
                    p.vy += 0.025; // 重力
                    p.rot += p.vr;
                    p.life -= 1;
                    drawPetal(p);
                    if (p.life <= 0) petals.splice(i,1);
                }
                requestAnimationFrame(tick);
            }
            tick();
        }

        // 初始化顶部下拉与菜单动作
        function initHeaderMenus() {
            // 下拉展开/收起
            const dropdownButtons = document.querySelectorAll('.menu-dropdown .menu-dropdown-btn');
            dropdownButtons.forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    const item = this.closest('.menu-dropdown');
                    const isOpen = item.classList.contains('open');
                    document.querySelectorAll('.menu-dropdown.open').forEach(x => x.classList.remove('open'));
                    if (!isOpen) item.classList.add('open');
                });
            });
            // 点击外部关闭
            document.addEventListener('click', function(e) {
                if (!e.target.closest('.menu-dropdown')) {
                    document.querySelectorAll('.menu-dropdown.open').forEach(x => x.classList.remove('open'));
                }
            });

            // 动作：新建、筛选、刷新、回顶、主题切换
            const newBlogLink = document.getElementById('menu-new-blog');
            if (newBlogLink) newBlogLink.addEventListener('click', function(e){
                e.preventDefault();
                const btn = document.getElementById('new-blog-btn');
                if (btn) btn.click();
            });
            const publishedLink = document.getElementById('menu-published');
            if (publishedLink) publishedLink.addEventListener('click', function(e){
                e.preventDefault();
                currentStatusFilter = 1;
                currentPage = 1;
                setFilterActiveButton();
                loadBlogs(1);
            });
            const draftsLink = document.getElementById('menu-drafts');
            if (draftsLink) draftsLink.addEventListener('click', function(e){
                e.preventDefault();
                currentStatusFilter = 0;
                currentPage = 1;
                setFilterActiveButton();
                loadBlogs(1);
            });
            const refreshLink = document.getElementById('menu-refresh');
            if (refreshLink) refreshLink.addEventListener('click', function(e){
                e.preventDefault();
                loadBlogs(currentPage || 1);
            });
            const topLink = document.getElementById('menu-top');
            if (topLink) topLink.addEventListener('click', function(e){
                e.preventDefault();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
            const themeLink = document.getElementById('menu-toggle-theme');
            if (themeLink) themeLink.addEventListener('click', function(e){
                e.preventDefault();
                document.body.classList.toggle('dark');
            });

            // 留言
            const chatLink = document.getElementById('menu-chat');
            if (chatLink) chatLink.addEventListener('click', function(e){
                e.preventDefault();
                openMessageModal();
            });

            // 关于我 / 联系我 弹窗
            const aboutLink = document.getElementById('menu-about');
            if (aboutLink) aboutLink.addEventListener('click', function(e){
                e.preventDefault();
                openInfoModal('关于我', `
                    <p>你好！我是Hope，一个热爱编程的年轻人。</p>
                    <p>我是一个喜欢研究技术的程序员，喜欢分享自己的学习心得和经验。</p>
                    <p>这是一个用gin框架搭建的博客系统，欢迎访问。</p>
                `);
            });
            const contactLink = document.getElementById('menu-contact');
            if (contactLink) contactLink.addEventListener('click', function(e){
                e.preventDefault();
                openInfoModal('联系我', `
                    <p>欢迎联系我：</p>
                    <ul>
                        <li>邮箱：15166622635@163.com</li>
                        <li>微信：15166622635</li>
                    </ul>
                `);
            });
        }

        // 打开/关闭 通用信息模态框
        function openInfoModal(title, html) {
            const titleEl = document.getElementById('info-title');
            const bodyEl = document.getElementById('info-body');
            const modal = document.getElementById('info-modal');
            if (!titleEl || !bodyEl || !modal) return;
            titleEl.textContent = title || '信息';
            // 使用 DOMPurify 进行安全渲染
            if (window.DOMPurify) {
                bodyEl.innerHTML = DOMPurify.sanitize(html || '');
            } else {
                bodyEl.innerHTML = html || '';
            }
            modal.style.display = 'block';
        }

        // 留言：打开/关闭/提交
        function openMessageModal(){
            const modal = document.getElementById('message-modal');
            if (modal) modal.style.display = 'block';
        }
        function closeMessageModal(){
            const modal = document.getElementById('message-modal');
            if (modal) modal.style.display = 'none';
        }

        // 绑定留言表单提交
        document.addEventListener('DOMContentLoaded', function(){
            const form = document.getElementById('message-form');
            if (form) {
                form.addEventListener('submit', function(e){
                    e.preventDefault();
                    const textarea = document.getElementById('message-text');
                    const message = (textarea && textarea.value || '').trim();
                    if (!message) {
                        alert('请输入留言内容');
                        return;
                    }
                    fetch('/api/messages', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        credentials: 'include',
                        body: JSON.stringify({ message })
                    })
                    .then(res => res.json())
                    .then(data => {
                        if (data && data.code === 200) {
                            alert('留言已提交');
                            textarea.value = '';
                            closeMessageModal();
                        } else {
                            alert(data?.msg || '提交失败');
                        }
                    })
                    .catch(() => {
                        alert('提交过程中发生错误');
                    });
                });
            }
        });
        function closeInfoModal() {
            const modal = document.getElementById('info-modal');
            if (modal) modal.style.display = 'none';
        }

        // 加载博客列表
        function loadBlogs(page = 1) {
            const blogList = document.getElementById('blog-list');
            const pagination = document.getElementById('pagination');
            
            blogList.innerHTML = '<div class="loading">加载中...</div>';
            // 带上筛选参数，避免草稿混入已发布
            const params = new URLSearchParams();
            params.set('page', page);
            params.set('page_size', 10);
            if (currentStatusFilter === 0) {
                params.set('status', 0);
                params.set('own', 1);
            } else {
                params.set('status', 1);
            }

            fetch(`/api/blogs?${params.toString()}`, {
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    displayBlogs(data.data.blogs);
                    displayPagination(data.data.pagination);
                    currentPage = page;
                } else {
                    blogList.innerHTML = '<div class="loading">暂无博客文章</div>';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                blogList.innerHTML = '<div class="loading">加载失败</div>';
            });
        }

        // 显示博客列表
        function displayBlogs(blogs) {
            const blogList = document.getElementById('blog-list');
            
            if (!blogs || blogs.length === 0) {
                blogList.innerHTML = '<div class="loading">暂无博客文章</div>';
                return;
            }
            // 前端兜底过滤，确保视图只显示当前筛选状态
            const filtered = (Array.isArray(blogs) ? blogs : []).filter(blog => {
                const status = typeof blog.status === 'number' ? blog.status : 1;
                return currentStatusFilter === 1 ? status === 1 : status === 0;
            });

            if (filtered.length === 0) {
                blogList.innerHTML = '<div class="loading">暂无博客文章</div>';
                return;
            }

            const blogsHtml = filtered.map(blog => {
                const username = (blog.author && blog.author.username) ? blog.author.username : '未知作者';
                const avatar = (blog.author && blog.author.avatar) ? blog.author.avatar : '';
                const created = blog.created_at ? formatDate(blog.created_at) : '';
                const views = typeof blog.view_count === 'number' ? blog.view_count : 0;
                const avatarHtml = avatar
                    ? `<img class="avatar" src="${avatar}" alt="${username}">`
                    : `<span class="avatar avatar-fallback">${username.slice(0,1).toUpperCase()}</span>`;
                return `
                <div class="blog-item" onclick="viewBlog(${blog.ID})">
                    <div class="blog-item-header">
                        ${avatarHtml}
                        <div>
                            <div class="blog-author">${username}</div>
                            <div style="font-size:12px;color:#999;">${created}</div>
                        </div>
                    </div>
                    <div class="blog-title">${blog.title}</div>
                    <div class="blog-summary">${blog.summary || '暂无摘要'}</div>
                    <div class="blog-footer">
                        <div class="metrics">
                            <span class="metric">👁️ ${views}</span>
                            <span class="metric">👍 ${blog.likes || 0}</span>
                            <span class="metric">⭐ ${blog.favorites || 0}</span>
                        </div>
                        <div style="font-size:12px;color:#999;">ID: ${blog.ID}</div>
                    </div>
                </div>`;
            }).join('');
            
            blogList.innerHTML = blogsHtml;
        }

        // 显示分页
        function displayPagination(pagination) {
            const paginationEl = document.getElementById('pagination');
            
            if (pagination.pages <= 1) {
                paginationEl.style.display = 'none';
                return;
            }
            
            paginationEl.style.display = 'flex';
            
            let paginationHtml = '';
            
            // 上一页按钮
            paginationHtml += `<button onclick="loadBlogs(${pagination.page - 1})" ${pagination.page <= 1 ? 'disabled' : ''}>上一页</button>`;
            
            // 页码按钮
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === pagination.page) {
                    paginationHtml += `<button class="active">${i}</button>`;
                } else {
                    paginationHtml += `<button onclick="loadBlogs(${i})">${i}</button>`;
                }
            }
            
            // 下一页按钮
            paginationHtml += `<button onclick="loadBlogs(${pagination.page + 1})" ${pagination.page >= pagination.pages ? 'disabled' : ''}>下一页</button>`;
            
            paginationEl.innerHTML = paginationHtml;
        }

        // 安全设置文本内容，元素不存在时仅告警不抛错
        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn('Missing element:', id);
                return false;
            }
            el.textContent = text ?? '';
            return true;
        }

        // 控制元素显示/隐藏
        function setDisplay(id, show) {
            const el = document.getElementById(id);
            if (!el) {
                console.warn('Missing element:', id);
                return false;
            }
            el.style.display = show ? '' : 'none';
            return true;
        }

        // 渲染博客详情（用于已发布或草稿）
        function renderBlogDetail(blog) {
            // 填充详情
            safeSetText('detail-title', '博客详情');
            safeSetText('detail-blog-title', blog.title || '');

            const authorName = blog.author && blog.author.username ? blog.author.username : '未知作者';
            const createdAt = blog.created_at ? formatDate(blog.created_at) : '';
            const viewCount = typeof blog.view_count === 'number' ? blog.view_count : 0;
            safeSetText('detail-meta', `作者: ${authorName} | 时间: ${createdAt} | 阅读: ${viewCount}`);

            const summaryText = (blog.summary || '').trim();
            const contentTextRaw = (blog.content || '').trim();
            const showSummary = summaryText.length > 0 && summaryText !== contentTextRaw;
            if (showSummary) {
                setDisplay('detail-summary', true);
                safeSetText('detail-summary', summaryText);
            } else {
                // 与内容相同或为空则不显示摘要，避免重复
                setDisplay('detail-summary', false);
                safeSetText('detail-summary', '');
            }
            // 使用 marked + DOMPurify 渲染 Markdown 并高亮代码
            try {
                const html = marked.parse(contentTextRaw, { mangle: false, headerIds: false });
                const safe = DOMPurify.sanitize(html);
                const el = document.getElementById('detail-content');
                if (el) {
                    el.innerHTML = safe;
                    el.querySelectorAll('pre code').forEach((block) => {
                        try { hljs.highlightElement(block); } catch (e) {}
                    });
                }
            } catch (e) {
                // 兜底为纯文本
                safeSetText('detail-content', contentTextRaw);
            }

            // 操作区
            const actions = document.getElementById('detail-actions');
            if (actions) {
                actions.innerHTML = '';
                const loginUserId = currentUser && (currentUser.user_id || currentUser.id);
                const authorId = blog.author_id || (blog.author && (blog.author.ID || blog.author.id));
                const isOwner = loginUserId && authorId && Number(loginUserId) === Number(authorId);
                if (isOwner) {
                    // 草稿：显示发布 + 删除
                    if (blog.status === 0) { 
                        const pubBtn = document.createElement('button');
                        pubBtn.textContent = '发布';
                        pubBtn.style.background = '#28a745';
                        pubBtn.style.color = '#fff';
                        pubBtn.style.border = 'none';
                        pubBtn.style.padding = '8px 12px';
                        pubBtn.style.borderRadius = '4px';
                        pubBtn.style.marginRight = '8px';
                        pubBtn.onclick = function () { publishBlog(blog); };
                        actions.appendChild(pubBtn);
                    }
                    // 删除按钮（草稿/已发布均可显示）
                    const delBtn = document.createElement('button');
                    delBtn.textContent = '删除博客';
                    delBtn.style.background = '#dc3545';
                    delBtn.style.color = '#fff';
                    delBtn.style.border = 'none';
                    delBtn.style.padding = '8px 12px';
                    delBtn.style.borderRadius = '4px';
                    delBtn.onclick = function () { deleteBlog(blog.ID || blog.id); };
                    actions.appendChild(delBtn);
                }
            }

            // 显示模态框
            openBlogDetailModal();
        }

        // 查看博客详情
        function viewBlog(id) {
            // 拉取详情
            fetch(`/api/blogs/${id}`, { credentials: 'include' })
                .then(res => res.json())
                .then(data => {
                    console.log('Debug: 详情接口 code =', data?.code, 'msg =', data?.msg);
                    if (data.code !== 200) {
                        alert(data.msg || '获取详情失败');
                        return;
                    }
                    renderBlogDetail(data.data);
                })
                .catch(err => {
                    console.error(err);
                    alert('获取详情过程中发生错误');
                });
        }

        // 发布博客（从草稿到已发布，不增加阅读量）
        function publishBlog(blog) {
            const id = blog.ID || blog.id;
            if (!id) return;
            if (!confirm('确认发布该草稿吗？')) return;
            const payload = {
                title: blog.title,
                content: blog.content,
                summary: blog.summary || '',
                status: 1
            };
            fetch(`/api/blogs/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(payload)
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    alert('发布成功');
                    closeBlogDetailModal();
                    loadBlogs(1);
                } else {
                    alert(data.msg || '发布失败');
                }
            })
            .catch(err => {
                console.error(err);
                alert('发布过程中发生错误');
            });
        }

        // 删除博客
        function deleteBlog(id) {
            if (!id) return;
            if (!confirm('确认删除该博客吗？此操作不可恢复。')) return;
            fetch(`/api/blogs/${id}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    alert('删除成功');
                    closeBlogDetailModal();
                    loadBlogs(1);
                } else {
                    alert(data.msg || '删除失败');
                }
            })
            .catch(err => {
                console.error(err);
                alert('删除过程中发生错误');
            });
        }

        function openBlogDetailModal() {
            const modal = document.getElementById('blog-detail-modal');
            if (!modal) {
                console.warn('Missing element: blog-detail-modal');
                return;
            }
            modal.style.display = 'block';
        }

        function closeBlogDetailModal() {
            const modal = document.getElementById('blog-detail-modal');
            if (!modal) {
                console.warn('Missing element: blog-detail-modal');
                return;
            }
            modal.style.display = 'none';
        }

        // 打开博客模态框
        function openBlogModal() {
            document.getElementById('blog-modal').style.display = 'block';
            document.getElementById('modal-title').textContent = '新建博客';
            document.getElementById('blog-form').reset();
        }

        // 关闭博客模态框
        function closeBlogModal() {
            document.getElementById('blog-modal').style.display = 'none';
        }

        // 处理博客表单提交
        function handleBlogSubmit(e) {
            e.preventDefault(); 
            if (isSavingDraft) {
                console.log('Debug: 正在保存草稿，忽略表单提交');
                return;
            }
            
            // 首先检查登录状态
            if (!currentUser) {
                alert('请先登录后再创建博客');
                return;
            }
            
            const formData = new FormData(e.target);
            const blogData = {
                title: formData.get('title'),
                summary: formData.get('summary'),
                content: formData.get('content'),
                status: formData.get('status') ? 1 : 0
            };
            
            console.log('Debug: 准备创建博客，当前用户:', currentUser);
            console.log('Debug: 博客数据:', blogData);
            
            fetch('/api/blogs', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(blogData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.code === 200) {
                    alert('博客创建成功！');
                    closeBlogModal();
                    loadBlogs(1); // 重新加载第一页
                } else {
                    alert(data.msg || '创建失败');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('创建过程中发生错误');
            });
        }

        // 存为草稿（status 强制为 0）
        function saveDraft() {
            if (!currentUser) {
                alert('请先登录后再保存草稿');
                return;
            }
            isSavingDraft = true;
            const form = document.getElementById('blog-form');
            const formData = new FormData(form);
            const blogData = {
                title: formData.get('title'),
                summary: formData.get('summary'),
                content: formData.get('content'),
                status: 0
            };
            console.log('Debug: 保存草稿，数据:', blogData);
            fetch('/api/blogs', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify(blogData)
            })
            .then(res => res.json())
            .then(data => {
                console.log('Debug: 保存草稿返回:', data);
                if (data.code === 200) {
                    console.log('Debug: 服务器返回的状态 status =', data?.data?.status);
                    alert('草稿已保存');
                    closeBlogModal();
                    // 切换到草稿视图并刷新
                    currentStatusFilter = 0;
                    setFilterActiveButton();
                    loadBlogs(1);
                } else {
                    alert(data.msg || '保存草稿失败');
                }
            })
            .catch(err => {
                console.error(err);
                alert('保存草稿过程中发生错误');
            })
            .finally(() => {
                isSavingDraft = false;
            });
        }

        // 格式化日期
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
    </script>
</body>
</html> 